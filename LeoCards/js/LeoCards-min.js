TLORM.QuickEntity.Card=function(j,b,c,a,g,f,e,i,d){return j.entity_manager.addEntity(new TLORM.Entity(b,[TLORM.Component.Render(1,a,null,null,c),TLORM.Component.Card(g),],f,e,i,d))};TLORM.QuickEntity.RandomCards=function(q,d,g,b,p,l,e){var c=e.length*2;var n=largest_factor(c);var r=c/n;var k=e.concat(e);k.sort(function(){return 0.5-Math.random()});for(var h=0;h<n;++h){for(var f=0;f<r;++f){var o=p+(g+p)*h;var m=l+(b+l)*f;var a=k.pop();TLORM.QuickEntity.Card(q,"","#CCC",a.colour,a.value,o,m,g,b)}}return{w:(n+1)*(g+p),h:(r+1)*(b+l)}};function largest_factor(b){var d=1;var f=b-d;for(var c=Math.floor(b/2);c>0;--c){var a=b/c;if(a%1==0){var e=Math.abs(c-a);if(e<f){d=c;f=e}}}return d}TLORM.System.UserInput=function(){return{type:"UserInput",touch_event:null,init:function(a){var c=this;a.registerEvent("click",function(e){c.clickHandler(e);e.preventDefault();return false});a.registerEvent("touch",function(e){c.clickHandler(e);e.preventDefault();return false});var d=["touchstart","touchchange","touchmove","touchend","gesturestart","gesturechange","gesturemove","gestureend"];for(var b=0;b<d.length;++b){a.registerEvent(d[b],function(e){e.preventDefault();return false})}},clickHandler:function(a){this.touch_event=a},update:function(a){var c=this.cardClicked(a);if(c){var b=c.getComponentByType("Card");var d=c.getComponentByType("Animation");if(!b.face_up&&!d){this.flipCard(a,c,b)}}},cardClicked:function(a){if(this.touch_event){var c=this.touch_event;this.touch_event=null;var d=a.entity_manager.getEntitiesByType("Card");for(var b=0;b<d.length;++b){if(d[b].x<=c.offsetX&&c.offsetX<=d[b].x+d[b].w&&d[b].y<=c.offsetY&&c.offsetY<=d[b].y+d[b].h){return d[b]}}}return null},flipCard:function(c,e,d){var f={x:e.x,y:e.y,w:e.w,h:e.h};var b=5;var a=Math.floor(e.w/b);c.entity_manager.addEntityComponent(e,TLORM.Component.Animation(b,function(g){},function(h,g){c.entity_manager.addEntityComponent(e,TLORM.Component.Transform(a,null,-2*a,null))},function(g){c.entity_manager.addEntityComponent(e,TLORM.Component.Transform(null,null,null,null,f.x,f.y,f.w,f.h));d.face_up=true}))}}};TLORM.System.RenderCards=function(b,a,c){return{type:"RenderCards",context:b,w:a,h:c,update:function(d){this.context.clearRect(0,0,this.w,this.h);var f=this.getCards(d);for(var e=0;e<f.length;++e){this.renderCard(f[e])}},renderCard:function(g){var k=g.getComponentByType("Render");var f=g.getComponentByType("Card");if(f.face_up){this.context.fillStyle=k.fill_colour;this.context.fillRect(g.x,g.y,g.w,g.h);this.context.fillStyle="#000";this.context.font=g.h+"px Arial";this.context.textAlign="center";this.context.fillText(f.value,g.x+(g.w/2),g.y+(g.h*0.85));if(f.matched){this.context.strokeStyle="#FFF";this.context.lineWidth=4;this.context.strokeRect(g.x,g.y,g.w,g.h)}var i=g.getComponentByType("Sprite");if(i){var d=g.x+(g.w*i.dx);var l=g.y+(g.h*i.dy);var e=g.w*i.dw;var j=g.h*i.dh;this.context.drawImage(i.img,i.x,i.y,i.w,i.h,d,l,e,j)}}else{this.context.fillStyle=k.other_fill_colour;this.context.fillRect(g.x,g.y,g.w,g.h)}},getCards:function(d){return d.entity_manager.getEntitiesByType("Card")}}};TLORM.System.Scoring=function(){var a=5;return{type:"Scoring",flipping_back:false,flip_back_step:0,score:0,update:function(b){var h=[];var g=this.getCards(b);var e=g.length;for(var d=0;d<g.length;++d){var c=g[d].getComponentByType("Card");var f=g[d].getComponentByType("Animation");if(c.matched){--e}else{if(c.face_up&&!f){h.push({card:g[d],card_data:c})}}}if(e==0){b.gameOver(true,this.score)}if(this.flipping_back){if(this.flip_back_step++>=a){for(var d=0;d<h.length;++d){this.flipCard(b,h[d].card,h[d].card_data)}this.flipping_back=false;this.score-=20}}else{if(h[0]&&h[1]){if(h[0].card_data.value==h[1].card_data.value){h[0].card_data.matched=true;h[1].card_data.matched=true;this.score+=100}else{this.flipping_back=true;this.flip_back_step=0}}}},getCards:function(b){return b.entity_manager.getEntitiesByType("Card")},flipCard:function(d,f,e){var g={x:f.x,y:f.y,w:f.w,h:f.h};var c=5;var b=Math.floor(f.w/c);d.entity_manager.addEntityComponent(f,TLORM.Component.Animation(c,function(h){},function(i,h){d.entity_manager.addEntityComponent(f,TLORM.Component.Transform(b,null,-2*b,null))},function(h){d.entity_manager.addEntityComponent(f,TLORM.Component.Transform(null,null,null,null,g.x,g.y,g.w,g.h));e.face_up=false}))}}};var canvas;var game;var cw=80;var ch=100;var sw=10;var sh=10;var numbers=[{colour:"#F00",value:1},{colour:"#0F0",value:2},{colour:"#00F",value:3},{colour:"#FF0",value:4},{colour:"#0FF",value:5},{colour:"#F0F",value:6},];var letters=[{colour:"#F00",value:"A"},{colour:"#0F0",value:"B"},{colour:"#00F",value:"C"},{colour:"#FF0",value:"D"},{colour:"#0FF",value:"E"},{colour:"#F0F",value:"F"},];window.onload=function(){canvas=document.getElementById("tlorm_game_canvas");game=new TLORM.Game("LeoDots",canvas);game.onStop=function(){new_game()};new_game()};function new_game(){game.reset();var d=[];var c=game.param("type");if(c=="numbers"){d=numbers}else{if(c=="letters"){d=letters}else{throw"Unknown type: "+c;return}}var a=game.param("num");if(a&&a<d.length){d.splice(a)}var b=TLORM.QuickEntity.RandomCards(game,"Random",cw,ch,sw,sh,d);game.setSize(b.w,b.h);game.system_manager.addSystem(new TLORM.System.RenderCards(game.canvasContext(),canvas.width,canvas.height));game.system_manager.addSystem(new TLORM.System.UserInput());game.system_manager.addSystem(new TLORM.System.Scoring());game.start()}TLORM.Component.Card=function(a){return{type:"Card",value:a,face_up:false,matched:false}};