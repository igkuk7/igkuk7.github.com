TLORM.Component.TubeRowContainer=function(b,a,c){return{type:"TubeRowContainer",rows:b,colours:c,positions:[],end:a,rows_being_flipped:0,moves:0,fills:0,filling:{},swap:TLORM.Component._TubeRowContainer.swap,calculatePositions:TLORM.Component._TubeRowContainer.calculatePositions,getPosition:TLORM.Component._TubeRowContainer.getPosition,init:function(d){this.calculatePositions()}}};TLORM.Component._TubeRowContainer={};TLORM.Component._TubeRowContainer.swap=function(d,c){var e=this.rows[d];this.rows[d]=this.rows[c];this.rows[c]=e};TLORM.Component._TubeRowContainer.getPosition=function(b,a){if(b<0){b=this.positions.length+b}return this.positions[b][a]};TLORM.Component._TubeRowContainer.calculatePositions=function(){var g=[];var e=this.rows[0].getComponentByType("TubeRow");for(var f=0;f<e.cols;++f){g.push(f)}var c=[g];var a=g;for(var f=0;f<this.rows.length;++f){var b=[];var e=this.rows[f].getComponentByType("TubeRow");for(var d=0;d<e.mapping.length;++d){b[e.mapping[d]]=a[d]}c.push(b);a=b}this.positions=c;for(var f=0;f<this.end.length;++f){if(this.getPosition(-1,f)==this.end[f]){this.filling[f]=true}else{this.filling[f]=false}}};TLORM.Component.TubeRow=function(c,a,b){return{type:"TubeRow",cols:c,mapping:a,fixed:b||false,tube_clicked:null,flipHorizontal:TLORM.Component._TubeRow.flipHorizontal,flipVertical:TLORM.Component._TubeRow.flipVertical,swapTubeEnds:TLORM.Component._TubeRow.swapTubeEnds,swapTubeStarts:TLORM.Component._TubeRow.swapTubeStarts}};TLORM.Component._TubeRow={};TLORM.Component._TubeRow.flipHorizontal=function(){var b=[];for(var a=0;a<this.cols;++a){b[a]=(this.cols-1)-this.mapping[this.cols-1-a]}this.mapping=b};TLORM.Component._TubeRow.flipVertical=function(){var b=[];for(var a=0;a<this.cols;++a){b[this.mapping[a]]=a}this.mapping=b};TLORM.Component._TubeRow.swapTubeStarts=function(d,c){var e=this.mapping[d];this.mapping[d]=this.mapping[c];this.mapping[c]=e};TLORM.Component._TubeRow.swapTubeEnds=function(d,c){var f=-1;var e=-1;for(var g=0;g<this.cols;++g){if(this.mapping[g]==d){f=g}if(this.mapping[g]==c){e=g}}this.swapTubeStarts(f,e)};TLORM.QuickEntity.RandomLevelSolution={};TLORM.QuickEntity.RandomLevel=function(z,m,g,n,u,l,o,d){var a=[];for(var s=0;s<o;s++){a.push(s)}var v=[];for(var t=0;t<l;t++){var k=a.slice();k.sort(function(){return 0.5-Math.random()});v.push(TLORM.QuickEntity.TubeRow(z,"Row"+(t+1),m,(u/2)+g+t*u,n*o,u,o,k,(Math.random()<0)))}var e=TLORM.QuickEntity.TubeRowContainer(z,"RandomLevel","RowContainer",m,g,n*o,u*(l+1),v,[]);var p=e.getComponentByType("TubeRowContainer");p.calculatePositions();p.end=p.positions[l].slice();TLORM.QuickEntity.RandomLevelSolution={};var c=Math.floor(l*o/2);for(var t=0;t<c;++t){var r=(Math.random()<0.5?"V":"H");var f=Math.floor(Math.random()*l);var q=r+(f+1);if(TLORM.QuickEntity.RandomLevelSolution[q]){continue}var b=v[f].getComponentByType("TubeRow");if(b.fixed){continue}switch(r){case"V":b.flipVertical();break;case"H":b.flipHorizontal();break;default:break}TLORM.QuickEntity.RandomLevelSolution[q]=true}p.calculatePositions();console.log(TLORM.QuickEntity.RandomLevelSolution);for(var t=0;t<p.end.length;++t){if(p.getPosition(-1,t)==p.end[t]){p.filling[t]=true}else{p.filling[t]=false}}return e};TLORM.QuickEntity.TubeRowContainer=function(i,g,a,e,d,f,c,j,b){return i.entity_manager.addEntity(new TLORM.Entity(g,[TLORM.Component.Render(1,null,"#000"),TLORM.Component.TubeRowContainer(j,b,["#F00","#0F0","#00F","#FF0","#0FF","#B4B","#BB4","#4BB","#44B","#B44","#4B4"])],e,d,f,c))};TLORM.QuickEntity.TubeRow=function(j,b,g,e,i,d,f,a,c){return j.entity_manager.addEntity(new TLORM.Entity(b,[TLORM.Component.Render(1,"#CCC","#000"),TLORM.Component.TubeRow(f,a,c)],g,e,i,d))};TLORM.QuickEntity.Level=function(B,A,n,l,p,v){var a=B.resource_manager.loadFile(A);var b=a.split("\n");var q=0;var m=0;var z=[];var d=[];var f=[];for(var u=0;u<b.length;u++){var o=b[u];if(o.indexOf("=")===-1){var e=false;var c=o.length;if(o.substr(c-1,1)==="F"){e=true;--c}if(c>q){q=c}var k=[];for(var t=0;t<c;t++){k.push(o.substr(t,1)-1)}z.push(TLORM.QuickEntity.TubeRow(B,"Row"+(u+1),n,(v/2)+l+u*v,p*q,v,q,k,e))}else{if(o.indexOf("E=")!=-1){var r=o.substr(2);for(var t=0;t<r.length;t++){d.push(r.substr(t,1)-1)}}else{if(o.indexOf("M=")!=-1){var C=o.substr(2);f=C.split(",")}}}}m=z.length;for(var u=0;u<f.length;++u){var s=f[u].substr(0,1);var g=f[u].substr(1,1)-1;switch(s){case"V":z[g].getComponentByType("TubeRow").flipVertical();break;case"H":z[g].getComponentByType("TubeRow").flipHorizontal();break;default:break}}return TLORM.QuickEntity.TubeRowContainer(B,A,"RowContainer",n,l,p*q,v*(m+1),z,d)};TLORM.System.RenderTubes=function(d,a,e){var c=15;var f=10;var b=10;return{type:"RenderTubes",context:d,w:a,h:e,update:function(s){this.context.clearRect(0,0,this.w,this.h);var r=(s.entity_manager.getEntitiesByType("TubeRowContainer"))[0];var h=r.getComponentByType("TubeRowContainer");var t=0;var p=0;var q=r.h;for(var n=0;n<h.rows.length;++n){var m=h.rows[n];var g=m.getComponentByType("TubeRow");this.renderRow(h,m,g);var o=m.w/g.cols;var k=m.h;for(var l=0;l<g.cols;++l){if(g.tube_clicked!=null&&g.tube_clicked==g.mapping[l]){this.context.lineWidth=c;this.renderRowPaths(h,m,g.mapping,n,l,o,k,true,true)}else{this.context.lineWidth=c;this.renderRowPaths(h,m,g.mapping,n,l,o,k,true)}this.context.lineWidth=c-3;this.renderRowPaths(h,m,g.mapping,n,l,o,k)}if(!m.getComponentByType("Transform")&&!m.getComponentByType("Animation")){t=o;p=k}}this.renderStart(r.x,r.y,t,p,h);this.renderDesiredEnd(r.x,q-(p/2),t,p,h);this.renderContainer(r)},renderContainer:function(g){var h=g.getComponentByType("Render");if(h.fill_colour){this.context.fillStyle=h.fill_colour;this.context.fillRect(g.x,g.y,g.w,g.h)}if(h.stroke_colour){this.context.lineWidth=1;this.context.strokeStyle=h.stroke_colour;this.context.strokeRect(g.x,g.y,g.w,g.h)}},renderRow:function(g,h,i){var j=h.getComponentByType("Render");if(j.fill_colour){this.context.fillStyle=(i.fixed?"#444":j.fill_colour);this.context.fillRect(h.x,h.y,h.w,h.h)}if(j.stroke_colour){this.context.lineWidth=1;this.context.strokeStyle=j.stroke_colour;this.context.strokeRect(h.x,h.y,h.w,h.h)}},renderRowPaths:function(i,n,h,s,l,p,k,g,q){var o=p/100;var j=n.h/1.1;if(g){if(q){this.context.strokeStyle="#0FF"}else{this.context.strokeStyle="#000"}}else{var r=i.getPosition(s,l);if(i.filling[r]&&i.rows_being_flipped==0){this.context.strokeStyle=i.colours[r]}else{this.context.strokeStyle="#FFF"}}var m=1;if(l===h[l]){m=0}else{if(l>h[l]){m=-1}}this.context.beginPath();this.context.moveTo(n.x+((l+0.5)*p),n.y-1);if(m===0){this.context.lineTo(n.x+((h[l]+0.5)*p),n.y+n.h+1)}else{this.context.bezierCurveTo(n.x+((l+0.5)*p)+(m*o),n.y+j,n.x+((h[l]+0.5)*p)-(m*o),n.y+n.h-j,n.x+((h[l]+0.5)*p),n.y+n.h+1)}this.context.stroke()},renderDesiredEnd:function(g,m,k,l,h){for(var j=0;j<h.end.length;++j){this.context.lineWidth=1;this.context.strokeStyle="#000";this.context.fillStyle=h.colours[h.end[j]];this.context.fillRect(g+(j*k),m,k,l/2);this.context.strokeRect(g+(j*k),m,k,l/2)}},renderStart:function(g,m,k,l,h){for(var j=0;j<h.end.length;++j){this.context.lineWidth=1;this.context.strokeStyle="#000";this.context.fillStyle=h.colours[j];this.context.fillRect(g+(j*k),m,k,l/2);this.context.strokeRect(g+(j*k),m,k,l/2)}}}};TLORM.System.UserInput=function(){return{type:"UserInput",touch_event:null,init:function(a){var b=this;a.registerEvent("click",function(c){b.clickHandler(c)});a.registerEvent("touch",function(c){b.clickHandler(c)})},clickHandler:function(a){this.touch_event=a},update:function(b){if(this.touch_event){var c=(b.entity_manager.getEntitiesByType("TubeRowContainer"))[0];var a=c.getComponentByType("TubeRowContainer");this.tubeClicked(b,c,a);this.touch_event=null}},startClicked:function(c,e,b){return null;if(this.touch_event){var g=this.touch_event;var d=b.rows[0].getComponentByType("TubeRow");if(e.x<=g.offsetX&&g.offsetX<=e.x+e.w&&e.y<=g.offsetY&&g.offsetY<=e.y+b.rows[0].h/2){var f=e.w/d.cols;var a=Math.floor((g.offsetX-e.x)/f);return a}}return -1},tubeClicked:function(l,j,c){if(this.touch_event){var b=this.touch_event;var h=l.entity_manager.getEntitiesByType("TubeRow");for(var e=0;e<h.length;++e){var d=h[e];if(d.x<=b.offsetX&&b.offsetX<=d.x+d.w&&d.y<=b.offsetY&&b.offsetY<=d.y+d.h){var f=100;if(d.x<=b.offsetX&&b.offsetX<=d.x+f||d.x+d.w-f<=b.offsetX&&b.offsetX<=d.x+ +d.w){d.edge_click=true}var a=d.getComponentByType("TubeRow");var g=d.w/a.cols;var k=Math.floor((b.offsetX-d.x)/g);if(a.tube_clicked!=null){if(a.tube_clicked!=k){a.swapTubeEnds(a.tube_clicked,k);c.calculatePositions()}a.tube_clicked=null}else{a.tube_clicked=k}return null}}}return null},horizontalTubeFlip:function(c,a,f,d){var e={x:f.x,y:f.y,w:f.w,h:f.h};var b=Math.floor(f.w/10);c.entity_manager.addEntityComponent(f,TLORM.Component.Animation(10,function(g){},function(h,g){c.entity_manager.addEntityComponent(f,TLORM.Component.Transform(b,null,-2*b,null))},function(g){c.entity_manager.addEntityComponent(f,TLORM.Component.Transform(null,null,null,null,e.x,e.y,e.w,e.h));d.flipHorizontal();a.calculatePositions();--a.rows_being_flipped}));++a.rows_being_flipped},verticalTubeFlip:function(c,b,f,d){var e={x:f.x,y:f.y,w:f.w,h:f.h};var a=Math.floor(f.h/10);c.entity_manager.addEntityComponent(f,TLORM.Component.Animation(10,function(g){},function(h,g){c.entity_manager.addEntityComponent(f,TLORM.Component.Transform(null,a,null,-2*a))},function(g){c.entity_manager.addEntityComponent(f,TLORM.Component.Transform(null,null,null,null,e.x,e.y,e.w,e.h));d.flipVertical();b.calculatePositions();--b.rows_being_flipped}));++b.rows_being_flipped}}};TLORM.System.Scoring=function(){var a=[];return{type:"Scoring",update:function(d){var e=(d.entity_manager.getEntitiesByType("TubeRowContainer"))[0];var b=e.getComponentByType("TubeRowContainer");a[e.name]=b.rows.length*b.end.length*100-(b.moves*50)-(b.fills*25);if(b.rows_being_flipped==0){var c=b.end.length;for(var f=0;f<b.end.length;++f){if(b.filling[b.end[f]]&&b.end[f]===b.getPosition(-1,f)){--c}}if(c===0){d.gameOver(true,a[e.name])}}}}};var game;window.onload=function(){var a=document.getElementById("tlorm_game_canvas");game=new TLORM.Game("Tubular",a);var b=new TLORM.GameMenu(game,"TubularMenu.json");game.onStop=function(){game.reset();b.reset();b.show()};b.show()};function show_level(){var f=game.entity_manager.getEntitiesByType("TubeRowContainer");if(f.length==0){return}var a=f[0].getComponentByType("TubeRowContainer");if(!a){return}var d="";for(var e=0;e<a.rows.length;++e){var c=a.rows[e].getComponentByType("TubeRow");for(var b=0;b<c.mapping.length;++b){d+=c.mapping[b]}if(a.rows[e].fixed){d+="F"}d+="\n"}d+="E=";for(var e=0;e<a.end.length;++e){d+=a.end[e]}d+="\n";window.open("data:text/plain;charset=utf-8,"+escape(d),"_blank")};