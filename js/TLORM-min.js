var TLORM=TLORM||{};TLORM.System={};TLORM.EntityManager=function(){this.next_id=1;this.entities=[];this.entities_by_type={};this.entities_by_id={}};TLORM.EntityManager.prototype.addEntity=function(a){a.id=this.next_id++;this.entities.push(a);for(var b=0;b<a.components.length;++b){if(!this.entities_by_type[a.components[b].type]){this.entities_by_type[a.components[b].type]=[]}this.entities_by_type[a.components[b].type].push(a)}this.entities_by_id[a.id]=a;return a};TLORM.EntityManager.prototype.removeEntity=function(a){for(var d=0;d<this.entities.length;++d){if(this.entities[d]===a){this.entities.splice(d,1);break}}for(d=0;d<a.components.length;++d){var c=a.components[d];if(this.entities_by_type[c.type]){for(var b=0;b<this.entities_by_type[c.type].length;++b){if(this.entities_by_type[c.type][b]===a){this.entities_by_type[c.type].splice(b,1);break}}}}if(this.entities_by_id[a.id]){delete this.entities_by_id[a.id]}};TLORM.EntityManager.prototype.getEntities=function(){return this.entities};TLORM.EntityManager.prototype.getEntitiesByType=function(a){if(this.entities_by_type[a]){return this.entities_by_type[a]}return[]};TLORM.EntityManager.prototype.getEntitiesByPosition=function(a,d){var c=[];for(var b=0;b<this.entities.length;b++){if(this.entities[b].x===a&&this.entities[b].y===d){c.push(this.entities[b])}}return c};TLORM.EntityManager.prototype.addEntityComponent=function(a,b){if(this.entities_by_id[a.id]){var d=a.getComponentByType(b.type);if(d){this.removeEntityComponent(a,d)}a.addComponent(b);if(!this.entities_by_type[b.type]){this.entities_by_type[b.type]=[]}this.entities_by_type[b.type].push(a)}};TLORM.EntityManager.prototype.removeEntityComponent=function(a,b){if(this.entities_by_id[a.id]){a.removeComponent(b);for(var c=0;c<this.entities_by_type[b.type].length;++c){if(this.entities_by_type[b.type][c]===a){this.entities_by_type[b.type].splice(c,1);break}}}};TLORM.EntityManager.prototype.initAllEntities=function(a){for(var b=0;b<this.entities.length;++b){this.entities[b].initAllComponents(a)}};TLORM.EntityManager.prototype.getRequiredSystems=function(){var b=[];for(var a=0;a<this.entities.length;++a){b=b.concat(this.entities[a].getRequiredSystems())}return b};TLORM.System.Debug=function(a){return{type:"Debug",component_types:a,update:function(b){var d=[];if(!this.component_types){d=b.entity_manager.getEntities()}for(var c=0;c<d.length;++c){console.log("Entity: "+d[c].name)}}}};TLORM.System.Transformation=function(a){return{type:"Transformation",update:function(c){var f=this.getTransforms(c);for(var e=0;e<f.length;++e){var b=f[e];var d=b.getComponentByType("Transform");if(d.dx!=null){b.x+=d.dx}if(d.dy!=null){b.y+=d.dy}if(d.x!=null){b.x=d.x}if(d.y!=null){b.y=d.y}if(d.dw!=null){b.w+=d.dw}if(d.dh!=null){b.h+=d.dh}if(d.w!=null){b.w=d.w}if(d.h!=null){b.h=d.h}c.entity_manager.removeEntityComponent(b,d)}},getTransforms:function(b){return b.entity_manager.getEntitiesByType("Transform")}}};TLORM.System.Animation=function(a){return{type:"Animation",update:function(c){var f=this.getAnimations(c);for(var d=0;d<f.length;++d){var b=f[d];var e=b.getComponentByType("Animation");if(e.step==0){e.on_start(e);++e.step}else{if(e.step>=e.steps){e.on_end(e);c.entity_manager.removeEntityComponent(b,e)}else{e.on_step(e,e.step);++e.step}}}},getAnimations:function(b){return b.entity_manager.getEntitiesByType("Animation")}}};TLORM.Component={};TLORM.GameMenu=function(b,a){this.game=b;this.context=this.game.canvasContext();this.menus_def=b.resource_manager.loadJSON(a);this.w=this.menus_def.w;this.h=this.menus_def.h;this.start_game=this.menus_def.game;this.menus={};for(var c in this.menus_def.menus){var d=this.menus_def.menus[c];this.menus[c]=d}this.option_position={x:30,y:this.h/2,w:this.w-60,h:30,dh:20,label_x:this.w/2,label_dy:23};this.reset()};TLORM.GameMenu.prototype.reset=function(){this.current_menu=this.menus_def.start;this.current_option_args=[];this.game.setSize(this.w,this.h);var a=this;this.game.unregisterAllEvents();this.game.registerEvent("click",function(b){a.clickHandler(b)});this.game.registerEvent("touch",function(b){a.clickHandler(b)})};TLORM.GameMenu.prototype.show=function(){if(this.current_menu=="game"){this.game.unregisterAllEvents();var a=this.current_option_args.slice();a.unshift(this.game);this.start_game.apply(this.start_game,a)}else{this.display(this.current_menu);this.game.update()}};TLORM.GameMenu.prototype.display=function(b){var d=this.menus[b];this.context.fillStyle=d.background;this.context.fillRect(0,0,this.w,this.h);this.context.fillStyle="#000";this.context.font="30px Arial";this.context.textAlign="center";this.context.fillText(d.title,this.w/2,30);this.context.font="20px Arial";for(var a=0;a<d.messages.length;++a){var c=60+(30*a);this.context.fillText(d.messages[a],this.w/2,c)}this.context.font="20px Arial";this.context.textAlign="center";this.context.strokeStyle="#000";for(var a=0;a<d.options.length;++a){var c=this.option_position.y+((this.option_position.h+this.option_position.dh)*a);this.context.fillStyle="#ABC";this.context.fillRect(this.option_position.x,c,this.option_position.w,this.option_position.h);this.context.strokeRect(this.option_position.x,c,this.option_position.w,this.option_position.h);this.context.fillStyle="#000";this.context.fillText(d.options[a].title,this.option_position.label_x,c+this.option_position.label_dy)}};TLORM.GameMenu.prototype.clickHandler=function(c){var b=this.menus[this.current_menu].options;if(this.option_position.x<=c.offsetX&&c.offsetX<=this.option_position.x+this.option_position.w&&this.option_position.y<=c.offsetY&&c.offsetY<=this.option_position.y+((this.option_position.h+this.option_position.dh)*b.length)){var a=Math.floor((c.offsetY-this.option_position.y)/(this.option_position.h+this.option_position.dh));if(c.offsetY<=this.option_position.y+((this.option_position.h+this.option_position.dh)*a)+this.option_position.h){this.current_menu=b[a].destination;this.current_option_args=b[a].args;this.show()}}};TLORM.SystemManager=function(){this.next_id=1;this.systems=[];this.systems_by_type={};this.systems_by_id={}};TLORM.SystemManager.prototype.getSystemByType=function(a){return this.systems_by_type[a]};TLORM.SystemManager.prototype.addSystem=function(a){a.id=this.next_id++;this.systems.push(a);this.systems_by_type[a.type]=a;this.systems_by_id[a.id]=a};TLORM.SystemManager.prototype.getSystems=function(){return this.systems};TLORM.SystemManager.prototype.initAllSystems=function(a){for(var b=0;b<this.systems.length;++b){if(this.systems[b].init){this.systems[b].init(a)}}};TLORM.SystemManager.prototype.updateAllSystems=function(a){for(var b=0;b<this.systems.length;++b){this.systems[b].update(a)}};(function(i,j,c,h,l,f,b){j.seedrandom=function g(m,q){var o=[];var n;m=k(a(q?[m,i]:arguments.length?m:[new Date().getTime(),i,window],3),o);n=new e(o);k(n.S,i);j.random=function p(){var t=n.g(h);var s=b;var r=0;while(t<l){t=(t+r)*c;s*=c;r=n.g(1)}while(t>=f){t/=2;s/=2;r>>>=1}return(t+r)/s};return m};function e(r){var q,o,v=this,s=r.length;var p=0,n=v.i=v.j=v.m=0;v.S=[];v.c=[];if(!s){r=[s++]}while(p<c){v.S[p]=p++}for(p=0;p<c;p++){q=v.S[p];n=d(n+q+r[p%s]);o=v.S[n];v.S[p]=o;v.S[n]=q}v.g=function m(C){var A=v.S;var z=d(v.i+1);var y=A[z];var x=d(v.j+y);var w=A[x];A[z]=w;A[x]=y;var B=A[d(y+w)];while(--C){z=d(z+1);y=A[z];x=d(x+y);w=A[x];A[z]=w;A[x]=y;B=B*c+A[d(y+w)]}v.i=z;v.j=x;return B};v.g(c)}function a(p,q,m,r,n){m=[];n=typeof(p);if(q&&n=="object"){for(r in p){if(r.indexOf("S")<5){try{m.push(a(p[r],q-1))}catch(o){}}}}return(m.length?m:p+(n!="string"?"\0":""))}function k(m,o,p,n){m+="";p=0;for(n=0;n<m.length;n++){o[d(n)]=d((p^=o[d(n)]*19)+m.charCodeAt(n))}m="";for(n in o){m+=String.fromCharCode(o[n])}return m}function d(m){return m&(c-1)}b=j.pow(c,h);l=j.pow(2,l);f=l*2;k(j.random(),i)})([],Math,256,6,52);TLORM.QuickEntity={};TLORM.Entity=function(c,f,a,g,b,e){this.id=null;this.name=c;this.x=a;this.y=g;this.w=b;this.h=e;this.components=[];this.components_by_type={};if(f){for(var d=0;d<f.length;++d){this.addComponent(f[d])}}};TLORM.Entity.prototype.addComponent=function(a){this.components.push(a);this.components_by_type[a.type]=a};TLORM.Entity.prototype.removeComponent=function(a){for(var b=0;b<this.components.length;++b){if(this.components[b]===a){this.components.splice(b,1)}}delete this.components_by_type[a.type]};TLORM.Entity.prototype.getComponentByType=function(a){if(this.components_by_type[a]){return this.components_by_type[a]}return null};TLORM.Entity.prototype.initAllComponents=function(a){for(var b=0;b<this.components.length;++b){if(this.components[b].init){this.components[b].init(a)}}};TLORM.Entity.prototype.initAllComponents=function(a){for(var b=0;b<this.components.length;++b){if(this.components[b].init){this.components[b].init(a)}}};TLORM.Entity.prototype.getRequiredSystems=function(){var b=[];for(var a=0;a<this.components.length;++a){if(this.components[a].system){b.push(this.components[a].system)}}return b};TLORM.Component.Render3D=function(e,c,d,a,b){return{type:"Render3D",z:e,highlight_alpha:a,fill_colour:c,other_fill_colour:b,stroke_colour:d,show_name:false}};TLORM.Component.Sprite=function(a,f,e,g,c,j,i,b,d){return{type:"Sprite",src:a,x:f,y:e,w:g,h:c,dx:j||1,dy:i||1,dw:b||1,dh:d||1,img:null,init:function(h){this.img=h.resource_manager.addImage(this.src)}}};TLORM.Component.Transform=function(d,c,e,g,a,i,b,f){return{type:"Transform",system:"Transformation",dx:d,dy:c,dw:e,dh:g,x:a,y:i,w:b,h:f}};TLORM.Component.Animation=function(b,d,a,c){return{type:"Animation",system:"Animation",on_start:d,on_step:a,on_end:c,step:0,steps:b}};TLORM.Component.Render=function(e,c,d,a,b){return{type:"Render",z:e,highlight_alpha:a,fill_colour:c,other_fill_colour:b,stroke_colour:d,show_name:false}};TLORM.Game=function(b,a){this.name=b;this.canvas=a;this.context=this.canvas.getContext("2d");this.running=false;this.loop_time=33;this.stop_message="GAME OVER!";this.default_systems=["Animation","Transformation"];this.onStop=null;this.events={};this.entity_manager=new TLORM.EntityManager();this.resource_manager=new TLORM.ResourceManager();this.system_manager=new TLORM.SystemManager();this.parseParams()};TLORM.Game.prototype.parseParams=function(){this.params={};if(location.search){var c=location.search.substring(1).split("&");for(var a=0;a<c.length;a++){var b=c[a].split("=");if(b[0]){this.params[b[0]]=b[1]}}}};TLORM.Game.prototype.param=function(a){return this.params[a]};TLORM.Game.prototype.reset=function(){this.entity_manager=new TLORM.EntityManager();this.resource_manager=new TLORM.ResourceManager();this.system_manager=new TLORM.SystemManager()};TLORM.Game.prototype.border=function(){return 10};TLORM.Game.prototype.setSize=function(a,b){this.canvas.width=a;this.canvas.height=b;if(this.buffer_context){this.buffer_canvas.width=a;this.buffer_canvas.height=b}};TLORM.Game.prototype.canvasContext=function(){if(!this.buffer_context){this.buffer_canvas=document.createElement("canvas");this.buffer_canvas.width=this.canvas.width;this.buffer_canvas.height=this.canvas.height;this.buffer_context=this.buffer_canvas.getContext("2d")}return this.buffer_context};TLORM.Game.prototype.registerEvent=function(a,b){this.canvas.addEventListener(a,b);if(!this.events[a]){this.events[a]=[]}this.events[a].push(b)};TLORM.Game.prototype.unregisterAllEvents=function(b){if(b){if(this.events[b]){for(var a=0;a<this.events[b].length;++a){this.canvas.removeEventListener(b,this.events[b][a])}}}else{for(var b in this.events){this.unregisterAllEvents(b)}}};TLORM.Game.prototype.start=function(){this.entity_manager.initAllEntities(this);var b=this.default_systems.concat(this.entity_manager.getRequiredSystems());for(var a=0;a<b.length;++a){if(!this.system_manager.getSystemByType(b[a])){this.system_manager.addSystem(new TLORM.System[b[a]]())}}this.system_manager.initAllSystems(this);this.startIfResourcesLoaded()};TLORM.Game.prototype.startIfResourcesLoaded=function(){if(!this.resource_manager.allLoaded(this)){var a=this;setTimeout(function(){a.startIfResourcesLoaded()},100)}else{this.running=true;this.loop()}};TLORM.Game.prototype.stop=function(b){this.running=false;var a=this;setTimeout(function(){if(b){var c=alert(a.stop_message)}if(a.onStop){a.onStop()}},this.loop_time)};TLORM.Game.prototype.gameOver=function(b,a){this.stop_message="GAME OVER!\n"+(b?"Congratulations, you won!":"Sorry, you lost!")+(a?" Your score was "+a:"");this.stop(true)};TLORM.Game.prototype.loop=function(){if(this.running){this.update();var a=this;setTimeout(function(){a.loop()},this.loop_time)}};TLORM.Game.prototype.update=function(){this.system_manager.updateAllSystems(this);this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.drawImage(this.buffer_canvas,0,0)};TLORM.ResourceManager=function(){this.images={};this.files={};this.json={};this.to_load=0};TLORM.ResourceManager.prototype.addImage=function(c){if(this.images[c]){return this.images[c].img}var b=new Image();++this.to_load;var a=this;b.onload=function(){--a.to_load;a.images[c].loaded=true};b.src=c+"?"+new Date().getTime();this.images[c]={img:b,loaded:false};return b};TLORM.ResourceManager.prototype.getImage=function(a){return this.images[a].img};TLORM.ResourceManager.prototype.loadFile=function(c){if(this.files[c]){return this.files[c].contents}++this.to_load;this.files[c]={contents:null,loaded:false};var b=this;var a=new XMLHttpRequest();a.onreadystatechange=function(){if(a.readyState===4){--b.to_load;b.files[c].contents=a.responseText;b.files[c].loaded=true}};a.open("GET",c+"?"+new Date().getTime(),false);a.send();return this.files[c].contents};TLORM.ResourceManager.prototype.getFile=function(a){return this.files[a].contents};TLORM.ResourceManager.prototype.loadJSON=function(src){if(this.json[src]){return this.json[src].contents}++this.to_load;this.json[src]={contents:null,loaded:false};var rm=this;var ajax=new XMLHttpRequest();ajax.onreadystatechange=function(){if(ajax.readyState===4){--rm.to_load;rm.json[src].contents=eval("("+ajax.responseText+")");rm.json[src].loaded=true}};ajax.open("GET",src+"?"+new Date().getTime(),false);ajax.send();return this.json[src].contents};TLORM.ResourceManager.prototype.getJSON=function(a){return this.json[a].contents};TLORM.ResourceManager.prototype.allLoaded=function(a){return this.to_load===0};